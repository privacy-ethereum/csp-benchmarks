name: Collect & Parse Artifacts (fan-in)

# Will be triggered by the completion of any of the following workflows:
on:
  workflow_run:
    workflows: ["Rust Benchmarks (parallel)", "Non-Rust Benchmarks (parallel)"]
    types: [completed]
  workflow_dispatch:
    inputs:
      sha:
        description: "Commit SHA to collect results for (defaults to current HEAD)"
        required: false
        type: string

# collapse multiple triggers for the same commit into one survivor
concurrency:
  group: fanin-${{ github.event.inputs.sha || github.event.workflow_run.head_sha || github.sha }}
  cancel-in-progress: true

permissions:
  actions: read
  contents: read

jobs:
  collect:
    runs-on: macos-latest
    env:
      HOMEBREW_NO_AUTO_UPDATE: "1"
      HOMEBREW_NO_ENV_HINTS: "1"
      SHA: ${{ github.event.inputs.sha || github.event.workflow_run.head_sha || github.sha }}
      GH_TOKEN: ${{ github.token }}
      # keep in sync with on.workflow_run.workflows
      REQUIRED_WORKFLOWS_JSON: '["Rust Benchmarks (parallel)", "Non-Rust Benchmarks (parallel)"]'
    steps:
      - uses: actions/checkout@v4

      # Installation is necessary for a non-GitHub runner
      - name: Install gh
        run: brew install gh

      - name: Install jq
        run: brew install jq

      - name: Auth gh
        run: gh auth setup-git
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: "Gate - proceed only when all parent workflows completed for this commit"
        id: gate
        shell: bash
        run: |
          set -euo pipefail
          echo "Target SHA: $SHA"
          all_done=true
          any_failed=false
          summary=""
          while IFS= read -r wf; do
            run_json=$(gh run list --workflow "$wf" --limit 50 \
              --json databaseId,headSha,conclusion,status,displayTitle,workflowName \
              --jq "map(select(.headSha==\"$SHA\"))[0]")
            if [[ "$run_json" == "null" || -z "$run_json" ]]; then
              all_done=false
              summary+="$wf: pending (not started)\n"
              continue
            fi
            status=$(jq -r '.status' <<<"$run_json")
            conclusion=$(jq -r '.conclusion' <<<"$run_json")
            run_id=$(jq -r '.databaseId' <<<"$run_json")
            summary+="$wf: status=$status conclusion=$conclusion run_id=$run_id\n"
            if [[ "$status" != "completed" ]]; then
              all_done=false
            elif [[ "$conclusion" != "success" ]]; then
              any_failed=true
            fi
          done < <(jq -r '.[]' <<<"$REQUIRED_WORKFLOWS_JSON")
          echo -e "$summary"
          if ! $all_done; then
            echo "Some parent workflows are still running or not started. Exiting early; will be triggered again."
            echo "proceed=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          if $any_failed; then
            echo "One or more parents failed. Proceeding to collect what is available."
          fi
          echo "proceed=true" >> "$GITHUB_OUTPUT"

      - name: Download artifacts from each parent run
        if: ${{ steps.gate.outputs.proceed == 'true' }}
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p inbox
          echo "Downloading artifacts for workflows listed in REQUIRED_WORKFLOWS_JSON: $REQUIRED_WORKFLOWS_JSON"
          while IFS= read -r wf; do
            RUN_ID=$(gh run list --workflow "$wf" --limit 50 \
              --json databaseId,headSha \
              --jq "map(select(.headSha==\"$SHA\"))[0].databaseId")
            [[ -z "$RUN_ID" || "$RUN_ID" == "null" ]] && { echo "No run for $wf (skipping)"; continue; }
            echo "Downloading artifacts for $wf (run_id=$RUN_ID) into inbox/$wf"
            gh run download "$RUN_ID" --dir "inbox/$wf" || echo "No artifacts to download for $wf (run_id=$RUN_ID). Continuing."
          done < <(jq -r '.[]' <<<"$REQUIRED_WORKFLOWS_JSON")

          echo "Artifact directory structure (depth 3):"
          find inbox -maxdepth 3 -print | sed 's/^/  /'

      - name: Stage downloaded artifacts into workspace
        if: ${{ steps.gate.outputs.proceed == 'true' }}
        shell: bash
        run: |
          set -euo pipefail
          set -x
          shopt -s nullglob

          # 1) Merge all Criterion artifact trees (named criterion-<crate>, see rust_benchmarks_parallel.yml) into ./target/criterion
          mkdir -p target/criterion
          while IFS= read -r -d '' critroot; do
            echo "Merging Criterion artifact: $critroot -> target/criterion"
            rsync -a "$critroot"/ target/criterion/
          done < <(find inbox -type d -maxdepth 3 -name 'criterion-*' -print0)

          # 2) Restore non-Rust metrics into their system folders (e.g., ./ligetron/*.json)
          while IFS= read -r -d '' outdir; do
            sys="$(basename "$outdir")"
            sys="${sys#benchmark-outputs-}"
            mkdir -p "$sys"
            if [[ -d "$outdir/$sys" ]]; then
              cp -a "$outdir/$sys/"*_metrics.json "$sys"/ || true
            else
              cp -a "$outdir/"*_metrics.json "$sys"/ || true
            fi
          done < <(find inbox -type d -name 'benchmark-outputs-*' -print0)

          # 3) Restore Rust metrics into their crate folders
          while IFS= read -r -d '' mdir; do
            crate="$(basename "$mdir")"
            crate="${crate#metrics-}"
            mkdir -p "$crate"
            if [[ -d "$mdir/$crate" ]]; then
              cp -a "$mdir/$crate/"*_metrics.json "$crate"/ || true
            else
              cp -a "$mdir/"*_metrics.json "$crate"/ || true
            fi
          done < <(find inbox -type d -name 'metrics-*' -print0)

          # 4) Restore Rust mem reports into their crate folders
          while IFS= read -r -d '' mdir; do
            crate="$(basename "$mdir")"
            crate="${crate#mem-}"
            mkdir -p "$crate"
            if [[ -d "$mdir/$crate" ]]; then
              cp -a "$mdir/$crate/"*_mem_report.json "$crate"/ || true
            else
              cp -a "$mdir/"*_mem_report.json "$crate"/ || true
            fi
          done < <(find inbox -type d -name 'mem-*' -print0)

          set +x
          echo "Workspace metrics discovered (depth 2):"
          find . -maxdepth 2 -name "*_metrics.json" -print | sed 's/^/  /'
          echo "Criterion entries present:"
          find target/criterion -maxdepth 2 -type d -print 2>/dev/null | sed 's/^/  /' || true

      - name: Install Rust toolchain (stable)
        if: ${{ steps.gate.outputs.proceed == 'true' }}
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true
          profile: minimal

      - name: Build utils
        if: ${{ steps.gate.outputs.proceed == 'true' }}
        run: cargo build --release -p utils

      - name: Collect benchmarks
        if: ${{ steps.gate.outputs.proceed == 'true' }}
        run: |
          set -euo pipefail
          cd utils
          cargo run --release --bin collect_benchmarks

      - name: Upload collected reports
        uses: actions/upload-artifact@v4
        if: ${{ always() && steps.gate.outputs.proceed == 'true' }}
        with:
          name: "collected-benchmarks"
          path: ./collected_benchmarks.json
          retention-days: 30
