name: Dispatch All Benchmarks (manual)

on:
  workflow_dispatch:
    inputs:
      ref:
        description: "Git ref name to run on (branch or tag)"
        required: false
      run_all:
        description: "Force running all benches regardless of changes"
        required: false
        default: true
        type: boolean
      include_optional:
        description: "Include the mobile-unfriendly systems (openvm, jolt, sp1)"
        required: false
        default: false
        type: boolean
      prod-run:
        description: "Run children on self-hosted runner"
        required: false
        default: false
        type: boolean

permissions:
  actions: write
  contents: read

jobs:
  dispatch:
    runs-on: macos-latest
    steps:
      - name: Install gh
        env:
          HOMEBREW_NO_AUTO_UPDATE: "1"
          HOMEBREW_NO_ENV_HINTS: "1"
        run: brew install gh

      - name: Determine ref
        id: ref
        shell: bash
        run: |
          set -euo pipefail
          REF_INPUT="${{ github.event.inputs.ref }}"
          if [[ -n "$REF_INPUT" ]]; then
            echo "ref=$REF_INPUT" >> "$GITHUB_OUTPUT"
          else
            echo "ref=${GITHUB_REF_NAME}" >> "$GITHUB_OUTPUT"
          fi

      - name: Dispatch Rust Benchmarks (parallel)
        env:
          GH_TOKEN: ${{ github.token }}
          PROD_RUN: ${{ github.event.inputs['prod-run'] }}
        shell: bash
        run: |
          set -euo pipefail
          REF='${{ steps.ref.outputs.ref }}'
          RUN_ALL='${{ github.event.inputs.run_all }}'
          INCLUDE_OPTIONAL='${{ github.event.inputs.include_optional }}'
          gh workflow run -R "$GITHUB_REPOSITORY" "Rust Benchmarks (parallel)" \
            --ref "$REF" \
            -f run_all="$RUN_ALL" \
            -f include_optional="$INCLUDE_OPTIONAL" \
            -f prod_run="$PROD_RUN"

      - name: Dispatch Non-Rust Benchmarks (parallel)
        env:
          GH_TOKEN: ${{ github.token }}
          PROD_RUN: ${{ github.event.inputs['prod-run'] }}
        shell: bash
        run: |
          set -euo pipefail
          REF='${{ steps.ref.outputs.ref }}'
          RUN_ALL='${{ github.event.inputs.run_all }}'
          gh workflow run -R "$GITHUB_REPOSITORY" "Non-Rust Benchmarks (parallel)" \
            --ref "$REF" \
            -f run_all="$RUN_ALL" \
            -f prod_run="$PROD_RUN"
