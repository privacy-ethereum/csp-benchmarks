name: Non-Rust Benchmarks (parallel)

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number }}
  cancel-in-progress: true

on:
  push:
    branches:
      - "CSP-Q3-2025"
  pull_request:
    branches:
      - "CSP-Q3-2025"
  workflow_dispatch:
    inputs:
      run_all:
        description: "Run benches for all non-Rust systems"
        required: false
        default: false
        type: boolean

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1
  GITHUB_TOKEN: ${{ secrets.GH_PAT }}

jobs:
  prepare-deps:
    needs: detect-folders
    if: ${{ needs.detect-folders.outputs.folders != '' && needs.detect-folders.outputs.folders != '[]' }}
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup & build Ligero
        uses: ./.github/actions/install-ligero
        with:
          ligero_path: ./ligero
          dawn_commit: 41d631c0cbcd46ddc723222fc80890f4305dbc65
          install_prefix: ${{ github.workspace }}/.deps/install
          cmake_build_type: Release

  detect-folders:
    runs-on: macos-latest
    outputs:
      folders: ${{ steps.set.outputs.folders }}
    steps:
      - name: Check out full history
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine base‑remote and fetch it
        id: base
        run: |
          REMOTE=origin
          if [[ "${GITHUB_REPOSITORY}" != "privacy-ethereum/csp-benchmarks" ]]; then
            git remote add upstream https://github.com/privacy-ethereum/csp-benchmarks.git
            REMOTE=upstream
          fi

          BASE_BRANCH="CSP-Q3-2025"
          git fetch --prune --no-tags --depth=1 "$REMOTE" "$BASE_BRANCH"

          # expose for later steps
          echo "BASE_REF=${REMOTE}/${BASE_BRANCH}" >> "$GITHUB_OUTPUT"

      - name: Detect changed top-level folders
        id: set
        run: |
          BASE_REF="${{ steps.base.outputs.BASE_REF }}"

          RUN_ALL="${{ github.event.inputs.run_all }}"

          # ─── 1. list of top‑level folders to watch ────────────
          FOLDERS=(
            ligero
          )

          # ─── 2. filter by diff (or include all when run_all=true) ───────
          changed=()
          for d in "${FOLDERS[@]}"; do
            # skip if directory does not exist in the workspace
            [[ -d "$d" ]] || continue

            if [[ "$RUN_ALL" == "true" ]]; then
              changed+=("$d")
              continue
            fi

            if git diff --name-only "$BASE_REF"..HEAD 2>/dev/null | grep -qE "^${d}(/|$)"; then
              changed+=("$d")
            fi
          done

          # ─── 3. output JSON array ───────────────────────────────────────
          json=$(printf '%s\n' "${changed[@]}" | jq -R -s -c 'split("\n") | map(select(length>0))')

          echo "Detected changed folders: '$json'"
          echo "folders=$json" >> "$GITHUB_OUTPUT"

  run-benchmarks:
    if: ${{ needs.detect-folders.outputs.folders != '' && needs.detect-folders.outputs.folders != '[]' }}
    needs: [prepare-deps, detect-folders]
    runs-on: macos-latest
    strategy:
      fail-fast: false
      matrix:
        folder: ${{ fromJson(needs.detect-folders.outputs.folders) }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth:

      - name: Ensure jq present
        run: |
          if ! command -v jq >/dev/null 2>&1; then
            brew update >/dev/null
            brew install jq
          fi

      - name: Install hyperfine
        run: |
          if ! command -v hyperfine >/dev/null 2>&1; then
            brew update >/dev/null
            brew install hyperfine
          fi

      - name: Install Rust toolchain (stable)
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true
          profile: minimal

      - name: Build only utils (release)
        run: cargo build --release -p utils

      - name: Run benches in ${{ matrix.folder }}
        run: |
          set -euo pipefail
          if [[ -f ./benchmark.sh ]]; then
            bash ./benchmark.sh --system-dir "./${{ matrix.folder }}"
          else
            echo "benchmark.sh not found in repository root" >&2
            exit 1
          fi

      - name: Upload outputs for ${{ matrix.folder }}
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: "benchmark-outputs-${{ matrix.folder }}"
          path: |
            ${{ matrix.folder }}/hyperfine_*.json
            ${{ matrix.folder }}/*_mem_report_*.json
          if-no-files-found: warn
          retention-days: 30
