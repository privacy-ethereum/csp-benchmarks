name: Non-Rust Benchmarks (parallel)

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number }}
  cancel-in-progress: true

on:
  push:
    branches:
      - "CSP-Q3-2025"
  pull_request:
    branches:
      - "CSP-Q3-2025"
  workflow_dispatch:
    inputs:
      run_all:
        description: "Run benches for all non-Rust systems"
        required: false
        default: false
        type: boolean

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1
  GITHUB_TOKEN: ${{ secrets.GH_PAT }}

jobs:
  prepare-cache:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Cache everything
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin
            ~/.cargo/registry/index
            ~/.cargo/registry/cache
            ~/.cargo/git/db
            ~/.rustup
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Setup & build Ligero
        uses: ./.github/actions/install-ligero
        with:
          ligero_path: ./ligero
          dawn_commit: 41d631c0cbcd46ddc723222fc80890f4305dbc65
          install_prefix: ${{ github.workspace }}/.deps/install
          cmake_build_type: Release

  detect-crates:
    needs: prepare-cache
    runs-on: macos-latest
    outputs:
      crates: ${{ steps.set.outputs.crates }}
    steps:
      - name: Check out full history
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine base‑remote and fetch it
        id: base
        run: |
          REMOTE=origin
          if [[ "${GITHUB_REPOSITORY}" != "privacy-scaling-explorations/csp-benchmarks" ]]; then
            git remote add upstream https://github.com/privacy-scaling-explorations/csp-benchmarks.git
            REMOTE=upstream
          fi

          BASE_BRANCH="CSP-Q3-2025"
          git fetch --prune --no-tags --depth=1 "$REMOTE" "$BASE_BRANCH"

          # expose for later steps
          echo "BASE_REF=${REMOTE}/${BASE_BRANCH}" >> "$GITHUB_OUTPUT"

      - name: Detect changed top-level non-Rust folders
        id: set
        run: |
          BASE_REF="${{ steps.base.outputs.BASE_REF }}"

          RUN_ALL="${{ github.event.inputs.run_all }}"

          # ─── 1. list of top‑level folders to watch ────────────
          FOLDERS=(
            ligero
          )

          # ─── 2. filter by diff (or include all when run_all=true) ───────
          changed=()
          for d in "${FOLDERS[@]}"; do
            # skip if directory does not exist in the workspace
            [[ -d "$d" ]] || continue

            if [[ "$RUN_ALL" == "true" ]]; then
              changed+=("$d")
              continue
            fi

            if git diff --name-only "$BASE_REF"..HEAD 2>/dev/null | grep -qE "^${d}(/|$)"; then
              changed+=("$d")
            fi
          done

          # ─── 3. output JSON array ───────────────────────────────────────
          json=$(printf '%s\n' "${changed[@]}" | jq -R -s -c 'split("\n") | map(select(length>0))')

          echo "Detected changed folders: '$json'"
          echo "crates=$json" >> "$GITHUB_OUTPUT"

  bench:
    if: ${{ needs.detect-crates.outputs.crates != '' && needs.detect-crates.outputs.crates != '[]' }}
    needs: [prepare-cache, detect-crates]
    runs-on: macos-latest
    strategy:
      fail-fast: false
      matrix:
        crate: ${{ fromJson(needs.detect-crates.outputs.crates) }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth:

      - name: Restore Cargo cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Run benches in ${{ matrix.crate }}
        run: |
          cd ${{ matrix.crate }}
          cargo bench

      - name: Upload reports for ${{ matrix.crate }}
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: "criterion-${{ matrix.crate }}"
          path: ${{ matrix.crate }}/target/criterion
          retention-days: 30
