name: Rust Benchmarks (parallel)

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number }}
  cancel-in-progress: true

on:
  push:
    branches:
      - "CSP-Q3-2025"
  pull_request:
    branches:
      - "CSP-Q3-2025"
  workflow_dispatch:
    inputs:
      run_all:
        description: "Run benches for all benchmark crates"
        required: false
        default: false
        type: boolean

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1
  GITHUB_TOKEN: ${{ secrets.GH_PAT }}

jobs:
  detect-crates:
    runs-on: macos-latest
    outputs:
      crates: ${{ steps.set.outputs.crates }}
    steps:
      - name: Check out full history
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine base‑remote and fetch it
        id: base
        run: |
          REMOTE=origin
          if [[ "${GITHUB_REPOSITORY}" != "privacy-ethereum/csp-benchmarks" ]]; then
            git remote add upstream https://github.com/privacy-ethereum/csp-benchmarks.git
            REMOTE=upstream
          fi

          BASE_BRANCH="CSP-Q3-2025"
          git fetch --prune --no-tags --depth=1 "$REMOTE" "$BASE_BRANCH"

          # expose for later steps
          echo "BASE_REF=${REMOTE}/${BASE_BRANCH}" >> "$GITHUB_OUTPUT"

      - name: Detect changed benchmark crates
        id: set
        run: |
          BASE_REF="${{ steps.base.outputs.BASE_REF }}"

          RUN_ALL="${{ github.event.inputs.run_all }}"
          # ─── Run all benches when we're merging a PR ─────────────────────
          EVENT_NAME='${{ github.event_name }}'
          if [[ "$EVENT_NAME" == "push" ]]; then
            RUN_ALL="true"
          fi

          EXCLUDE_REGEX='^(utils|mobile|zkvm)(/|$)'

          # ─── 1. discover Cargo.toml files ────────────────────────────────
          dirs=$(find . -mindepth 2 -maxdepth 4 -type f -name Cargo.toml \
                  ! -path "./Cargo.toml" \
                | sed -e 's|^\./||' -e 's|/Cargo.toml$||' \
                | grep -vE "$EXCLUDE_REGEX" \
                | sort -u)

          # ─── 2. select top‑level dirs ───────────────────────────────────
          selected=()      # declare early to please `set -u`
          while IFS= read -r d; do
            skip=false
            for p in "${selected[@]-}"; do
              [[ "$d/" == "$p/"* ]] && skip=true && break
            done
            $skip || selected+=("$d")
          done < <(printf '%s\n' "$dirs" | awk '{print length,$0}' | sort -n | cut -d' ' -f2-)

          # ─── 3. filter by diff & [[bench]] ──────────────────────────────
          changed=()       # declare early
          for d in "${selected[@]}"; do
            # When RUN_ALL=true we ignore the diff check, otherwise we require a diff.
            if [[ "$RUN_ALL" != "true" ]]; then
              git diff --name-only "$BASE_REF"..HEAD 2>/dev/null | grep -q "^${d}/" || continue
            fi

            # Always require the crate to have a [[bench]] section.
            if grep -q '^\[\[bench\]\]' "$d/Cargo.toml"; then
              changed+=("$d")
            fi
          done

          # ─── 4. output JSON array ───────────────────────────────────────
          json=$(printf '%s\n' "${changed[@]}" |
            jq -R -s -c 'split("\n") | map(select(length>0))')

          echo "Detected changed crates: '$json'"
          echo "crates=$json" >> "$GITHUB_OUTPUT"

  prepare-cache:
    needs: detect-crates
    if: ${{ needs.detect-crates.outputs.crates != '' && needs.detect-crates.outputs.crates != '[]' }}
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Cache everything
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin
            ~/.cargo/registry/index
            ~/.cargo/registry/cache
            ~/.cargo/git/db
            ~/.rustup
            target
            nexus/target
            cairo-m/target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Install Rust toolchain
        uses: actions-rs/toolchain@v1
        with:
          toolchain: nightly-2025-08-18-aarch64-apple-darwin
          override: true
          profile: default
          default: true
          components: llvm-tools, rustc-dev, rustfmt, clippy

      - name: Install excluded crates toolchain
        uses: actions-rs/toolchain@v1
        with:
          toolchain: nightly-2025-04-06
          profile: minimal
          components: llvm-tools, rustc-dev, rust-src, rustfmt, clippy

      - name: Install OpenVM
        uses: ./.github/actions/install-openvm
      - name: Install OpenMPI for polyhedra-expander
        uses: ./.github/actions/install-ompi

      - name: Install RISC0 toolchain
        uses: ./.github/actions/install-risc0

      - name: Install SP1 toolchain
        uses: ./.github/actions/install-sp1

      - name: Install LLVM and LLD for cairo-m
        uses: ./.github/actions/install-llvm

      - name: Build full workspace (release)
        run: cargo build --release --workspace

      - name: Build nexus and cairo-m separately
        run: |
          cd nexus && cargo build --release && cd ..
          cd cairo-m && cargo build --release && cd ..

  bench:
    if: ${{ needs.detect-crates.outputs.crates != '' && needs.detect-crates.outputs.crates != '[]' }}
    needs: [prepare-cache, detect-crates]
    runs-on: macos-latest
    strategy:
      fail-fast: false
      matrix:
        crate: ${{ fromJson(needs.detect-crates.outputs.crates) }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth:

      - name: Restore Cargo cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
            nexus/target
            cairo-m/target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Install Rust toolchain
        uses: actions-rs/toolchain@v1
        with:
          toolchain: nightly-2025-08-18-aarch64-apple-darwin
          override: true
          profile: default
          default: true
          components: llvm-tools, rustc-dev

      - name: Install excluded crates toolchain
        if: ${{ contains(matrix.crate, 'nexus') || contains(matrix.crate, 'cairo-m') }}
        uses: actions-rs/toolchain@v1
        with:
          toolchain: nightly-2025-04-06
          profile: minimal
          components: llvm-tools, rustc-dev, rust-src, rustfmt, clippy

      - name: Install OpenVM
        if: ${{ contains(matrix.crate, 'openvm') }}
        uses: ./.github/actions/install-openvm

      - name: Install Nargo
        if: ${{ contains(matrix.crate, 'provekit') }}
        uses: ./.github/actions/install-nargo
        with:
          version: "1.0.0-beta.11"

      - name: Install OpenMPI for polyhedra-expander
        if: ${{ contains(matrix.crate, 'polyhedra-expander') }}
        uses: ./.github/actions/install-ompi

      - name: Install RISC0 toolchain
        if: ${{ contains(matrix.crate, 'risc0') }}
        uses: ./.github/actions/install-risc0

      - name: Install SP1 toolchain
        if: ${{ contains(matrix.crate, 'sp1') }}
        uses: ./.github/actions/install-sp1

      - name: Install LLVM and LLD for cairo-m
        if: ${{ contains(matrix.crate, 'cairo-m') }}
        uses: ./.github/actions/install-llvm

      - name: Run benches in ${{ matrix.crate }}
        run: |
          cd ${{ matrix.crate }}
          cargo bench

      - name: Copy memory benchmark binaries to workspace target
        if: ${{ contains(matrix.crate, 'nexus') || contains(matrix.crate, 'cairo-m') }}
        run: |
          mkdir -p target/release
          if [ -d "${{ matrix.crate }}/target/release" ]; then
            find "${{ matrix.crate }}/target/release" -maxdepth 1 -type f -perm +111 -exec cp {} target/release/ \;
          fi

      - name: Upload reports for ${{ matrix.crate }}
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: "criterion-${{ matrix.crate }}"
          path: |
            target/criterion
            ${{ matrix.crate }}/target/criterion
          if-no-files-found: warn
          retention-days: 30

      - name: Upload metrics for ${{ matrix.crate }}
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: "metrics-${{ matrix.crate }}"
          path: ${{ matrix.crate }}/**/*_metrics.json
          if-no-files-found: warn
          retention-days: 30

      - name: Upload mem reports for ${{ matrix.crate }}
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: "mem-${{ matrix.crate }}"
          path: |
            ${{ matrix.crate }}/*_mem_report.json
          if-no-files-found: warn
          retention-days: 30
