name: Upload Results to Supabase

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Environment to upload to"
        required: true
        default: "dev"
        type: choice
        options:
          - dev
          - staging
          - prod
      run_id:
        description: "Workflow run ID containing the collected-benchmarks artifact"
        required: true

permissions:
  actions: read
  contents: read

jobs:
  upload-benchmarks:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (optional if artifact only)
        uses: actions/checkout@v4

      - name: Install jq
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Download collected-benchmarks artifact
        uses: actions/download-artifact@v5
        with:
          name: collected-benchmarks
          path: ./artifacts
          run-id: ${{ inputs.run_id }}
          github-token: ${{ secrets.GH_PAT }}

      - name: Show files
        run: ls -al ./artifacts

      - name: Validate JSON
        run: |
          set -euo pipefail
          BENCH_JSON=$(find ./artifacts -type f -name 'collected_benchmarks.json' | head -n1)
          if [ -z "${BENCH_JSON}" ]; then
            echo "collected_benchmarks.json not found in ./artifacts" >&2
            exit 1
          fi
          jq . < "${BENCH_JSON}" > /dev/null

      - name: Upload Payload
        env:
          DEV_API_KEY: ${{ secrets.ETHPROOFS_DEV_KEY }}
          STAGING_API_KEY: ${{ secrets.ETHPROOFS_STAGING_KEY }}
          PROD_API_KEY: ${{ secrets.ETHPROOFS_API_KEY }}
        run: |
          set -euo pipefail
          if [ "${{ inputs.environment }}" = "dev" ]; then
            API_KEY="${DEV_API_KEY}"
            API_URL="https://deploy-preview-549--ethproofs.netlify.app/api/v0/csp-benchmarks/upload"
          elif [ "${{ inputs.environment }}" = "staging" ]; then
            API_KEY="${STAGING_API_KEY}"
            API_URL="https://staging--ethproofs.netlify.app/api/v0/csp-benchmarks/upload"
          else
            API_KEY="${PROD_API_KEY}"
            API_URL="https://ethproofs.net/api/v0/csp-benchmarks/upload"
          fi
          if [ -z "${API_KEY:-}" ]; then
            echo "ETHPROOFS_DEV_KEY secret is not set; aborting." >&2
            exit 1
          fi
          BENCH_JSON=$(find ./artifacts -type f -name 'collected_benchmarks.json' | head -n1)
          if [ -z "${BENCH_JSON}" ]; then
            echo "collected_benchmarks.json not found in ./artifacts" >&2
            exit 1
          fi
          DATA=$(cat "${BENCH_JSON}")
          RUN_ID="${{ inputs.run_id }}"
          curl -sS --fail-with-body -X POST ${API_URL} \
             -H "Authorization: Bearer ${API_KEY}" \
             -F "file=@${BENCH_JSON}" \
             -F "filename=collected-benchmarks-${RUN_ID}"
