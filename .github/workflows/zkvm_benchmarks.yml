name: zkVM Benchmarks

on:
  pull_request:
    branches: [CSP-Q3-2025]
    paths:
      - zkvm/**
      - utils/**

permissions:
  contents: read

concurrency:
  group: zkvm-benchmarks-${{ github.ref }}
  cancel-in-progress: true

env:
  GITHUB_TOKEN: ${{ secrets.GH_PAT }}
  CARGO_TERM_COLOR: always

jobs:
  ci:
    runs-on: macos-14
    defaults:
      run:
        working-directory: ./zkvm
        shell: bash
    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@master
        with:
          toolchain: stable
          components: llvm-tools, rustc-dev, rustfmt, clippy

      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: zkvm -> target
          cache-on-failure: true

      - name: Install RISC0 toolchain
        run: |
          set -Eeuo pipefail
          if [[ ! -x "$HOME/.risc0/bin/rzup" ]]; then
            curl -fsSL --retry 5 --proto '=https' --tlsv1.2 https://risczero.com/install | bash
          fi
          export PATH="$HOME/.risc0/bin:$PATH"
          echo "$HOME/.risc0/bin" >> "$GITHUB_PATH"
          rzup install rust 1.88.0
          rzup install cpp 2024.1.5
          rzup install r0vm 3.0.3
          rzup install cargo-risczero 3.0.3

      - name: Install SP1 toolchain
        run: |
          set -Eeuo pipefail
          if [[ ! -x "$HOME/.sp1/bin/sp1up" ]]; then
            curl -fsSL --retry 5 --proto '=https' --tlsv1.2 https://sp1up.succinct.xyz | bash
          fi
          export PATH="$HOME/.sp1/bin:$PATH"
          echo "$HOME/.sp1/bin" >> "$GITHUB_PATH"
          sp1up -v v5.2.1 --token "$GITHUB_TOKEN"
          cargo-prove prove --version

      - name: Check formatting
        run: cargo fmt --all -- --check

      - name: Build
        run: cargo build --release

      - name: Run clippy
        run: cargo clippy --all-targets --all-features -- -D warnings

      - name: Run benchmarks
        run: cargo bench
